name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download template
        run: |
          curl -sL "${{ github.event.client_payload.template_url }}" -o template
      
      - name: Generate formula
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
        run: |
          # Export all payload keys as environment variables
          eval "$(echo "$PAYLOAD" | jq -r 'to_entries | .[] | "export \(.key)=\(.value | @sh)"')"
          
          # Generate formula
          mkdir -p Formula
          envsubst < template > "Formula/${formula}.rb"
          cat "Formula/${formula}.rb"
      
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/
          git diff --staged --quiet || git commit -m "Update ${{ github.event.client_payload.formula }} to ${{ github.event.client_payload.version }}"
          git push
